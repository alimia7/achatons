rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role from profile
    function getUserRole() {
      let profile = get(/databases/$(database)/documents/profiles/$(request.auth.uid));
      return profile != null ? profile.data.role : null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function to check if user is seller
    function isSeller() {
      return isAuthenticated() && (getUserRole() == 'vendeur' || getUserRole() == 'seller');
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Profiles collection
    match /profiles/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can create their own profile on signup
      allow create: if isOwner(userId) && 
                       request.resource.data.id == userId &&
                       request.resource.data.role == 'user';
      
      // Users can update their own profile
      // Admins can update any profile (to change roles)
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete profiles
      allow delete: if isAdmin();
    }
    
    // Categories collection
    match /categories/{categoryId} {
      // Everyone can read categories
      allow read: if true;
      
      // Only admins can create, update, delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // Products collection (seller products)
    match /products/{productId} {
      // Everyone can read active products
      // Sellers can read their own products (active or inactive)
      // Admins can read all products
      allow read: if resource.data.status == 'active' || 
                     (isAuthenticated() && 
                      resource.data.seller_id != null &&
                      resource.data.seller_id == request.auth.uid) || 
                     isAdmin();
      
      // Sellers can create products (must be their own)
      // Also allow authenticated users to create (will be validated by seller_id check)
      allow create: if isAuthenticated() && 
                       request.resource.data.seller_id == request.auth.uid;
      
      // Sellers can update their own products
      // Admins can update any product
      allow update: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
      
      // Sellers can delete their own products
      // Admins can delete any product
      allow delete: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
    }
    
    // Offers collection
    match /offers/{offerId} {
      // Everyone can read active offers (even unauthenticated users)
      // Sellers can read their own offers (active or inactive)
      // Admins can read all offers
      allow read: if resource.data.status == 'active' || 
                     (isAuthenticated() && 
                      resource.data.seller_id != null && 
                      resource.data.seller_id == request.auth.uid) ||
                     isAdmin();
      
      // Sellers can create offers (must be their own)
      // Admins can create offers (with or without seller_id)
      allow create: if (isAuthenticated() && 
                           request.resource.data.seller_id == request.auth.uid) ||
                       isAdmin();
      
      // Sellers can update their own offers (if seller_id exists)
      // Admins can update any offer
      allow update: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
      
      // Sellers can delete their own offers (if seller_id exists)
      // Admins can delete any offer
      allow delete: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
    }
    
    // Helper function to check if offer belongs to seller
    function isSellerOffer(offerId) {
      let offer = get(/databases/$(database)/documents/offers/$(offerId));
      return offer != null && 
             offer.data.seller_id != null && 
             offer.data.seller_id == request.auth.uid;
    }
    
    // Participations collection
    match /participations/{participationId} {
      // Users can read their own participations (if user_id exists)
      // Sellers can read participations for their offers
      // Admins can read all participations
      allow read: if (resource.data.user_id != null && isOwner(resource.data.user_id)) ||
                     (isSeller() && isSellerOffer(resource.data.offer_id)) ||
                     isAdmin();
      
      // Anyone can create participations (for unauthenticated users)
      // Authenticated users can create their own participations (with user_id)
      allow create: if !isAuthenticated() || 
                       (isAuthenticated() && 
                        (request.resource.data.user_id == null || 
                         request.resource.data.user_id == request.auth.uid));
      
      // Users can update their own participations (if user_id exists)
      // Sellers can update participations for their offers (to validate/cancel)
      // Admins can update any participation
      allow update: if (resource.data.user_id != null && isOwner(resource.data.user_id)) ||
                     (isSeller() && isSellerOffer(resource.data.offer_id)) ||
                     isAdmin();
      
      // Users can delete their own participations (if user_id exists)
      // Sellers can delete participations for their offers
      // Admins can delete any participation
      allow delete: if (resource.data.user_id != null && isOwner(resource.data.user_id)) ||
                     (isSeller() && isSellerOffer(resource.data.offer_id)) ||
                     isAdmin();
    }
    
    // Deliveries collection
    match /deliveries/{deliveryId} {
      // Sellers can read their own deliveries
      // Admins can read all deliveries
      allow read: if (isAuthenticated() && 
                         resource.data.seller_id != null &&
                         isOwner(resource.data.seller_id)) || 
                     isAdmin();
      
      // Sellers can create deliveries (must be their own)
      allow create: if isAuthenticated() && 
                       request.resource.data.seller_id == request.auth.uid;
      
      // Sellers can update their own deliveries
      // Admins can update any delivery
      allow update: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
      
      // Sellers can delete their own deliveries
      // Admins can delete any delivery
      allow delete: if (isAuthenticated() && 
                           resource.data.seller_id != null &&
                           isOwner(resource.data.seller_id)) || 
                       isAdmin();
    }
    
    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

